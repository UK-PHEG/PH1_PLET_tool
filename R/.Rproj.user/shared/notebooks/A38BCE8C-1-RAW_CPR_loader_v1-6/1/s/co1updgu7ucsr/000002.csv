"0","#function to match data from WoRMS to the abundance datasets"
"0","load_worms <- function(x) {"
"0","  unique_aphias <- x %>%"
"0","    dplyr::select(aphia_id) %>%"
"0","    unique() %>%"
"0","    dplyr::mutate(aphia_id = as.integer(aphia_id))"
"0",""
"0","  "
"0","  if(file.exists(paste0(dir_main, ""aphia_ids_and_names_from_worms.csv""))){"
"0","    #load the file if it exists"
"0","    df_wms <- fread(paste0(dir_main, ""aphia_ids_and_names_from_worms.csv""))"
"0","    df_wms <- data.frame(lapply(df_wms, as.character), stringsAsFactors=FALSE)"
"0","  } else {"
"0","    #otherwise request data from WoRMS"
"0","    df_wms <- worms::wormsbyid(unique_aphias$aphia_id)"
"0","    df_wms <- data.frame(lapply(df_wms, as.character), stringsAsFactors=FALSE)"
"0","  }"
"0","  "
"0","  #check if all Aphia IDs in the dataset are present. If not, download the data again to update it."
"0","  if(!all(unique(x$aphia_id) %in% df_wms$AphiaID)){"
"0","      "
"0","      #find the additional missing IDs"
"0","      missing_ids <- sort(unique(x$aphia_id))[!sort(unique(x$aphia_id)) %in% df_wms$AphiaID]"
"0","      "
"0","      unique_aphias <- unique_aphias %>%"
"0","      filter(aphia_id == missing_ids)"
"0","     "
"0","      df_wms2 <- worms::wormsbyid(unique_aphias$aphia_id)"
"0","      df_wms2 <- data.frame(lapply(df_wms2, as.character), stringsAsFactors=FALSE)"
"0","  "
"0","      df_wms <- rbind(df_wms, df_wms2)"
"0","}"
"0",""
"0","  return(df_wms)"
"0",""
"0","}"
"0",""
"0","df_wms <- load_worms(x=df_cpr)"
"1","REQUESTING "
"1",""
"1","200"
"1",""
"1"," ITEMS BY ID from World Register of Marine Species  (www.marinespecies.org), "
"1",""
"1","03/03/2022 09:19:03"
"1",""
"1"," (CC-BY)
"
"1",","
"1",""
"1","104152"
"1",","
"1",""
"1","106485"
"1",","
"1",""
"1","149168"
"1",","
"1",""
"1","149230"
"1",","
"1",""
"1","341501"
"1",","
"1",""
"1","17446"
"1",","
"1",""
"1","1104"
"1",","
"1",""
"1","149055"
"1",","
"1",""
"1","149074"
"1",","
"1",""
"1","148912"
"1","
"
"1",","
"1",""
"1","179785"
"1",","
"1",""
"1","104468"
"1",","
"1",""
"1","105"
"1",","
"1",""
"1","196121"
"1",","
"1",""
"1","104544"
"1",","
"1",""
"1","104561"
"1",","
"1",""
"1","104563"
"1",","
"1",""
"1","104566"
"1",","
"1",""
"1","104086"
"1",","
"1",""
"1","359879"
"1","
"
"1",","
"1",""
"1","116598"
"1",","
"1",""
"1","149139"
"1",","
"1",""
"1","109566"
"1",","
"1",""
"1","341542"
"1",","
"1",""
"1","149153"
"1",","
"1",""
"1","149152"
"1",","
"1",""
"1","177604"
"1",","
"1",""
"1","163344"
"1",","
"1",""
"1","149112"
"1",","
"1",""
"1","149310"
"1","
"
"1",","
"1",""
"1","149113"
"1",","
"1",""
"1","149647"
"1",","
"1",""
"1","157440"
"1",","
"1",""
"1","149135"
"1",","
"1",""
"1","13703"
"1",","
"1",""
"1","558243"
"1",","
"1",""
"1","179596"
"1",","
"1",""
"1","613575"
"1",","
"1",""
"1","345513"
"1",","
"1",""
"1","149116"
"1","
"
"1",","
"1",""
"1","149629"
"1",","
"1",""
"1","149070"
"1",","
"1",""
"1","128634"
"1",","
"1",""
"1","370366"
"1",","
"1",""
"1","163030"
"1",","
"1",""
"1","149095"
"1",","
"1",""
"1","157083"
"1",","
"1",""
"1","149093"
"1",","
"1",""
"1","109951"
"1",","
"1",""
"1","109950"
"1","
"
"1",","
"1",""
"1","109963"
"1",","
"1",""
"1","109982"
"1",","
"1",""
"1","109967"
"1",","
"1",""
"1","109956"
"1",","
"1",""
"1","109964"
"1",","
"1",""
"1","156509"
"1",","
"1",""
"1","148947"
"1",","
"1",""
"1","162254"
"1",","
"1",""
"1","149118"
"1",","
"1",""
"1","149306"
"1","
"
"1",","
"1",""
"1","149655"
"1",","
"1",""
"1","149050"
"1",","
"1",""
"1","149156"
"1",","
"1",""
"1","149094"
"1",","
"1",""
"1","149157"
"1",","
"1",""
"1","149619"
"1",","
"1",""
"1","148992"
"1",","
"1",""
"1","148917"
"1",","
"1",""
"1","149023"
"1",","
"1",""
"1","149131"
"1","
"
"1",","
"1",""
"1","149028"
"1",","
"1",""
"1","149132"
"1",","
"1",""
"1","149033"
"1",","
"1",""
"1","163248"
"1",","
"1",""
"1","149106"
"1",","
"1",""
"1","149142"
"1",","
"1",""
"1","149004"
"1",","
"1",""
"1","149066"
"1",","
"1",""
"1","196811"
"1",","
"1",""
"1","149115"
"1","
"
"1",","
"1",""
"1","149630"
"1",","
"1",""
"1","149084"
"1",","
"1",""
"1","164116"
"1",","
"1",""
"1","109929"
"1",","
"1",""
"1","109930"
"1",","
"1",""
"1","109931"
"1",","
"1",""
"1","196820"
"1",","
"1",""
"1","109934"
"1",","
"1",""
"1","109935"
"1",","
"1",""
"1","109936"
"1","
"
"1",","
"1",""
"1","109943"
"1",","
"1",""
"1","109947"
"1",","
"1",""
"1","109953"
"1",","
"1",""
"1","109955"
"1",","
"1",""
"1","196822"
"1",","
"1",""
"1","109968"
"1",","
"1",""
"1","109969"
"1",","
"1",""
"1","109972"
"1",","
"1",""
"1","196824"
"1",","
"1",""
"1","109974"
"1","
"
"1",","
"1",""
"1","109977"
"1",","
"1",""
"1","109980"
"1",","
"1",""
"1","109462"
"1",","
"1",""
"1","109519"
"1",","
"1",""
"1","109528"
"1",","
"1",""
"1","109553"
"1",","
"1",""
"1","109550"
"1",","
"1",""
"1","109903"
"1",","
"1",""
"1","1100"
"1",","
"1",""
"1","106269"
"1","
"
"1",","
"1",""
"1","104193"
"1",","
"1",""
"1","104510"
"1",","
"1",""
"1","1102"
"1",","
"1",""
"1","106267"
"1",","
"1",""
"1","128672"
"1",","
"1",""
"1","104183"
"1",","
"1",""
"1","104616"
"1",","
"1",""
"1","104164"
"1",","
"1",""
"1","128690"
"1",","
"1",""
"1","104686"
"1","
"
"1",","
"1",""
"1","104743"
"1",","
"1",""
"1","104229"
"1",","
"1",""
"1","146142"
"1",","
"1",""
"1","1082"
"1",","
"1",""
"1","1806"
"1",","
"1",""
"1","104178"
"1",","
"1",""
"1","104275"
"1",","
"1",""
"1","104722"
"1",","
"1",""
"1","104478"
"1",","
"1",""
"1","104491"
"1","
"
"1",","
"1",""
"1","104494"
"1",","
"1",""
"1","345781"
"1",","
"1",""
"1","104552"
"1",","
"1",""
"1","104878"
"1",","
"1",""
"1","104464"
"1",","
"1",""
"1","104299"
"1",","
"1",""
"1","104301"
"1",","
"1",""
"1","104431"
"1",","
"1",""
"1","104576"
"1",","
"1",""
"1","104579"
"1","
"
"1",","
"1",""
"1","104580"
"1",","
"1",""
"1","104466"
"1",","
"1",""
"1","104640"
"1",","
"1",""
"1","104643"
"1",","
"1",""
"1","104542"
"1",","
"1",""
"1","128722"
"1",","
"1",""
"1","104342"
"1",","
"1",""
"1","104343"
"1",","
"1",""
"1","104465"
"1",","
"1",""
"1","220914"
"1","
"
"1",","
"1",""
"1","104120"
"1",","
"1",""
"1","104157"
"1",","
"1",""
"1","104159"
"1",","
"1",""
"1","104191"
"1",","
"1",""
"1","104128"
"1",","
"1",""
"1","104467"
"1",","
"1",""
"1","1302"
"1",","
"1",""
"1","104471"
"1",","
"1",""
"1","883"
"1",","
"1",""
"1","1137"
"1","
"
"1",","
"1",""
"1","106731"
"1",","
"1",""
"1","1131"
"1",","
"1",""
"1","106087"
"1",","
"1",""
"1","149668"
"1",","
"1",""
"1","1078"
"1",","
"1",""
"1","137751"
"1",","
"1",""
"1","799"
"1",","
"1",""
"1","104469"
"1",","
"1",""
"1","11707"
"1",","
"1",""
"1","104462"
"1","
"
"1",","
"1",""
"1","104108"
"1",","
"1",""
"1","104543"
"1",","
"1",""
"1","14355"
"1",","
"1",""
"1","104303"
"1",","
"1",""
"1","104906"
"1",","
"1",""
"1","104550"
"1",","
"1",""
"1","104633"
"1",","
"1",""
"1","104632"
"1",","
"1",""
"1","104642"
"1",","
"1",""
"1","104637"
"1","
"
"1",","
"1",""
"1","104638"
"1",","
"1",""
"1","104499"
"1",","
"1",""
"1","104639"
"1",","
"1",""
"1","104474"
"1",","
"1",""
"1","104208"
"1",","
"1",""
"1","104736"
"1",","
"1",""
"1","104496"
"1",","
"1",""
"1","104501"
"1",","
"1",""
"1","129715"
"1",","
"1",""
"1","1207"
"1","
"
"1",","
"1",""
"1","1205"
"1",","
"1",""
"1","1130"
"1",","
"1",""
"1","139178"
"1",","
"1",""
"1","138366"
"1",","
"1",""
"1","1128"
"1",","
"1",""
"1","2081"
"1",","
"1",""
"1","104161"
"1",","
"1",""
"1","10194"
"1",","
"1",""
"1","137217"
"1",","
"1",""
"1","137215"
"1","
"
"1","
"
"1","by id .............................................. DONE
"
"0","#save the updated Aphia ID and taxon list"
"0","fwrite(df_wms, paste0(dir_main, ""aphia_ids_and_names_from_worms.csv""))"
"0",""
"0","#replace taxon scientific names from WoRMS for relevant Aphia IDs in abundance data and sum per sample"
"0","df_cpr$taxon2 <- df_wms$scientificname[match(df_cpr$aphia_id, df_wms$AphiaID)]"
"0","df_cpr$taxon2[is.na(df_cpr$taxon2)] <- df_cpr$taxon[is.na(df_cpr$taxon2)]"
"0","df_cpr$taxon <- df_cpr$taxon2"
"0","df_cpr$taxon2 <- NULL"
"0",""
"0","df_output <- df_cpr %>%"
"0","    group_by(across(c(-count))) %>%"
"0","    dplyr::summarise(count = sum(count),"
"0","              .groups = ""drop"")"
